
AM_MAKEFLAGS = --no-print-directory

servicedir = $(datarootdir)/dbus-1/services

service_in_files =

doc_files = doc/obexd-api.txt doc/agent-api.txt doc/client-api.txt

test_files = test/simple-agent test/send-files \
		test/pull-business-card test/exchange-business-cards \
		test/list-folders test/pbap-client test/ftp-client \
		test/image_push_test test/image_pull_test \
		test/remote_display_test test/remote_camera_test \
		test/remote_display_agent test/remote_camera_agent \
		test/image_arch_test

gdbus_sources = gdbus/gdbus.h gdbus/mainloop.c gdbus/watch.c \
					gdbus/object.c gdbus/polkit.c

gwobex_sources = gwobex/gw-obex.h gwobex/gw-obex.c \
			gwobex/obex-priv.h gwobex/obex-priv.c \
			gwobex/obex-xfer.h gwobex/obex-xfer.c \
			gwobex/utils.h gwobex/utils.c gwobex/log.h

btio_sources = btio/btio.h btio/btio.c

gobex_sources = gobex/gobex.h gobex/gobex.c \
			gobex/gobex-defs.h gobex/gobex-defs.c \
			gobex/gobex-packet.c gobex/gobex-packet.h \
			gobex/gobex-header.c gobex/gobex-header.h \
			gobex/gobex-transfer.c

noinst_PROGRAMS =
libexec_PROGRAMS =

if SERVER
confdir = $(sysconfdir)/obex

service_in_files += src/obexd.service.in

builtin_modules =
builtin_sources =
builtin_nodist =

builtin_modules += bluetooth
builtin_sources += plugins/bluetooth.c

if USB
builtin_modules += usb
builtin_sources += plugins/usb.c
endif

builtin_modules += filesystem
builtin_sources += plugins/filesystem.c plugins/filesystem.h

builtin_modules += imgimgpush
builtin_sources += plugins/imgimgpush.c plugins/imgimgpush.h

builtin_modules += imglisting
builtin_sources += plugins/imglisting.c plugins/imglisting.h

builtin_modules += imgimgpull
builtin_sources += plugins/imgimgpull.c plugins/imgimgpull.h

builtin_modules += imgthmpull
builtin_sources += plugins/imgthmpull.c plugins/imgthmpull.h

builtin_modules += imgdisplay
builtin_sources += plugins/imgdisplay.c

builtin_modules += imgattpull
builtin_sources += plugins/imgattpull.c plugins/imgattpull.h

builtin_modules += imgpropull
builtin_sources += plugins/imgpropull.c plugins/imgpropull.h

builtin_modules += imgattpush
builtin_sources += plugins/imgattpush.c plugins/imgattpush.h

builtin_modules += imgarch
builtin_sources += plugins/imgarch.c

if NOKIA_PCSUITE
builtin_modules += pcsuite
builtin_sources += plugins/pcsuite.c
endif

builtin_modules += opp
builtin_sources += plugins/opp.c

builtin_modules += ftp
builtin_sources += plugins/ftp.c plugins/ftp.h

builtin_modules += pbap
builtin_sources += plugins/pbap.c plugins/phonebook.h \
			plugins/vcard.h plugins/vcard.c

builtin_modules += mas
builtin_sources += plugins/mas.c plugins/messages.h

builtin_modules += irmc
builtin_sources += plugins/irmc.c

builtin_modules += image_push
builtin_sources += plugins/image_push.c plugins/image_push.h

builtin_modules += remote_display
builtin_sources += plugins/remote_display.c plugins/remote_display.h

builtin_modules += remote_camera
builtin_sources += plugins/remote_camera.c plugins/remote_camera.h

builtin_modules += image_arch
builtin_sources += plugins/image_arch.c plugins/image_arch.h

builtin_modules += image_pull
builtin_sources += plugins/image_pull.c plugins/image_pull.h

builtin_modules += syncevolution
builtin_sources += plugins/syncevolution.c

builtin_modules += imgmonitoring
builtin_sources += plugins/imgmonitoring.c

builtin_nodist += plugins/phonebook.c
builtin_nodist += plugins/messages.c
builtin_sources += plugins/bip_util.c plugins/bip_util.h

libexec_PROGRAMS += src/obexd

src_obexd_SOURCES = $(gdbus_sources) $(builtin_sources) $(btio_sources) \
			$(gobex_sources) src/main.c src/obexd.h \
			src/plugin.h src/plugin.c \
			src/log.h src/log.c src/dbus.h src/manager.c \
			src/obex.h src/obex.c src/obex-priv.h \
			src/mimetype.h src/mimetype.c \
			src/service.h src/service.c \
			src/transport.h src/transport.c \
			src/server.h src/server.c \
			src/options.h src/options.c

src_obexd_LDADD = @DBUS_LIBS@ @GLIB_LIBS@ @GTHREAD_LIBS@ \
					@EBOOK_LIBS@ @OPENOBEX_LIBS@ \
					@BLUEZ_LIBS@ @LIBICAL_LIBS@ \
					@TRACKER_LIBS@ @MAGICKWAND_LIBS@ -ldl

src_obexd_LDFLAGS = -Wl,--export-dynamic

builtin_files = src/builtin.h $(builtin_nodist)

nodist_src_obexd_SOURCES = $(builtin_files)

plugindir = $(libdir)/obex/plugins

plugin_LTLIBRARIES =

noinst_PROGRAMS += test/obex-test

test_obex_test_SOURCES = $(gwobex_sources) test/main.c

test_obex_test_LDADD = @OPENOBEX_LIBS@ @BLUEZ_LIBS@ @GLIB_LIBS@

src/plugin.$(OBJEXT): src/builtin.h

src/builtin.h: src/genbuiltin $(builtin_sources)
	$(AM_V_GEN)$(srcdir)/src/genbuiltin $(builtin_modules) > $@

endif

if CLIENT
service_in_files += client/obex-client.service.in

libexec_PROGRAMS += client/obex-client

client_obex_client_SOURCES = $(gdbus_sources) $(gobex_sources) \
				$(gwobex_sources) $(btio_sources) \
				client/main.c src/log.h src/log.c \
				client/session.h client/session.c \
				client/pbap.h client/pbap.c \
				client/sync.h client/sync.c \
				client/transfer.h client/transfer.c \
				client/bip_pull.h client/bip_pull.c \
				client/bip_push.h client/bip_push.c \
				client/bip_util.h client/bip_util.c \
				client/bip_arch.h client/bip_arch.c \
				client/bip_rd.h client/bip_rd.c \
				client/bip_rc.h client/bip_rc.c \
				client/bip_bp.h client/bip_bp.c

client_obex_client_LDADD = @GLIB_LIBS@ @DBUS_LIBS@ @OPENOBEX_LIBS@ @BLUEZ_LIBS@ @MAGICKWAND_LIBS@
endif

service_DATA = $(service_in_files:.service.in=.service)

AM_CFLAGS = @OPENOBEX_CFLAGS@ @BLUEZ_CFLAGS@ @EBOOK_CFLAGS@ \
			@GTHREAD_CFLAGS@ @GLIB_CFLAGS@ @DBUS_CFLAGS@ \
			@LIBICAL_CFLAGS@ -D_FILE_OFFSET_BITS=64 \
			@TRACKER_CFLAGS@ @MAGICKWAND_CFLAGS@ \
			-DOBEX_PLUGIN_BUILTIN -DPLUGINDIR=\""$(plugindir)"\"

INCLUDES = -I$(builddir)/src -I$(srcdir)/src -I$(srcdir)/plugins \
				-I$(srcdir)/gdbus -I$(srcdir)/gwobex \
				-I$(srcdir)/btio -I$(srcdir)/gobex

CLEANFILES = $(service_DATA) $(builtin_files)

EXTRA_DIST = src/genbuiltin $(doc_files) $(test_files) \
			src/obexd.service.in client/obex-client.service.in \
			plugins/phonebook-dummy.c plugins/phonebook-ebook.c \
			plugins/phonebook-tracker.c \
			plugins/messages-dummy.c plugins/messages-tracker.c

DISTCHECK_CONFIGURE_FLAGS = --enable-client --enable-server

MAINTAINERCLEANFILES = Makefile.in \
	aclocal.m4 configure config.h.in config.sub config.guess \
	ltmain.sh depcomp compile missing install-sh mkinstalldirs

%.service: %.service.in config.log
	$(AM_V_GEN)$(SED) -e "s|\@libexecdir\@|$(libexecdir)|" $< > $@

plugins/phonebook.c: plugins/@PHONEBOOK_DRIVER@
	$(AM_V_GEN)$(LN_S) @abs_top_srcdir@/$< $@

plugins/messages.c: plugins/@MESSAGES_DRIVER@
	$(AM_V_GEN)$(LN_S) @abs_top_srcdir@/$< $@

TESTS = unit/test-gobex-header unit/test-gobex-packet unit/test-gobex \
		unit/test-gobex-transfer unit/test-gobex-transfer \
		unit/test-bip unit/test-bip-plugins

noinst_PROGRAMS += unit/test-gobex-header unit/test-gobex-packet \
		unit/test-gobex unit/test-gobex-transfer \
		unit/test-bip unit/test-bip-plugins

unit_test_gobex_SOURCES = $(gobex_sources) unit/test-gobex.c \
							unit/util.c unit/util.h
unit_test_gobex_LDADD = @GLIB_LIBS@

unit_test_gobex_packet_SOURCES = $(gobex_sources) unit/test-gobex-packet.c \
							unit/util.c unit/util.h
unit_test_gobex_packet_LDADD = @GLIB_LIBS@

unit_test_gobex_header_SOURCES = $(gobex_sources) unit/test-gobex-header.c \
							unit/util.c unit/util.h
unit_test_gobex_header_LDADD = @GLIB_LIBS@

unit_test_gobex_transfer_SOURCES = $(gobex_sources) unit/util.c unit/util.h \
						unit/test-gobex-transfer.c
unit_test_gobex_transfer_LDADD = @GLIB_LIBS@

unit_test_bip_SOURCES = client/bip_util.c $(gwobex_sources) $(gobex_sources) client/bip_util.h unit/util.c unit/util.h \
						unit/test-bip.c
unit_test_bip_LDADD = $(client_obex_client_LDADD)

unit_test_bip_plugins_SOURCES = $(nodist_src_obexd_SOURCES) \
				$(gdbus_sources) $(builtin_sources) $(btio_sources) \
				$(gobex_sources) \
				src/obexd.h \
				src/plugin.h src/plugin.c \
				src/log.h src/log.c src/dbus.h src/manager.c \
				src/obex.h src/obex.c src/obex-priv.h \
				src/mimetype.h src/mimetype.c \
				src/service.h src/service.c \
				src/transport.h src/transport.c \
				src/server.h src/server.c \
				src/options.h src/options.c \
				unit/util.c unit/util.h \
				unit/test-bip-plugins.c

unit_test_bip_plugins_LDADD = $(src_obexd_LDADD)

if READLINE
noinst_PROGRAMS += tools/test-client
tools_test_client_SOURCES = $(gobex_sources) $(btio_sources) \
							tools/test-client.c
tools_test_client_LDADD = @GLIB_LIBS@ @BLUEZ_LIBS@ @READLINE_LIBS@
endif

noinst_PROGRAMS += tools/test-server
tools_test_server_SOURCES = $(gobex_sources) $(btio_sources) \
							tools/test-server.c
tools_test_server_LDADD = @GLIB_LIBS@ @BLUEZ_LIBS@
